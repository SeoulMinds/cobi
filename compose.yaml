name: cobi-${TAG}

x-common-env-file: &common-env-file
  - ./.env

services:
  backend:
    container_name: cobi-backend-${TAG}
    build:
      context: ./backend
    ports:
      - "${BACKEND_PORT}:${BACKEND_PORT}"
    environment:
      MONGODB_URI: ${MONGODB_URI}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      GEMINI_API_KEY: ${GEMINI_API_KEY:-}
      FRONTEND_URL: ${FRONTEND_URL:-}
      BACKEND_PORT: ${BACKEND_PORT}
      QDRANT_HOST: qdrant
      QDRANT_PORT: 6333
    env_file: *common-env-file
    depends_on:
      mongodb:
        condition: service_healthy
      qdrant:
        condition: service_started
    networks:
      - cobi-network
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:${BACKEND_PORT}/health')"]
      interval: 10s
      timeout: 5s
      retries: 5

  frontend:
    container_name: cobi-frontend-${TAG}
    build:
      context: ./frontend
    ports:
      - "${FRONTEND_PORT}:${FRONTEND_PORT}"
    environment:
      VITE_API_BASE_URL: http://localhost:${BACKEND_PORT}
      VITE_BACKEND_PORT: ${BACKEND_PORT}
      FRONTEND_PORT: ${FRONTEND_PORT}
    env_file: *common-env-file
    depends_on:
      - backend
    networks:
      - cobi-network

  mongodb:
    container_name: cobi-mongodb-${TAG}
    image: mongo:8.0.13
    ports:
      - "${MONGODB_PORT:-27017}:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_ADMIN_USER}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_ADMIN_PASS}
    env_file: *common-env-file
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - cobi-network
    volumes:
      - mongo_data:/data/db

  mongo-express:
    container_name: cobi-mongo-express-${TAG}
    image: mongo-express:1.0.2-20
    ports:
      - "${MONGO_EXPRESS_PORT}:8081"
    environment:
      ME_CONFIG_MONGODB_ADMINUSERNAME: ${MONGO_ADMIN_USER}
      ME_CONFIG_MONGODB_ADMINPASSWORD: ${MONGO_ADMIN_PASS}
      ME_CONFIG_MONGODB_SERVER: mongodb
      ME_CONFIG_MONGODB_PORT: 27017
      ME_CONFIG_MONGODB_ENABLE_ADMIN: "true"
      ME_CONFIG_BASICAUTH_USERNAME: ${MONGO_EXPRESS_USERNAME}
      ME_CONFIG_BASICAUTH_PASSWORD: ${MONGO_EXPRESS_PASSWORD}
      ME_CONFIG_BASICAUTH: "true"
      ME_CONFIG_SITE_COOKIESECRET: ${MONGO_EXPRESS_COOKIE_SECRET}
      ME_CONFIG_SITE_SESSIONSECRET: ${MONGO_EXPRESS_SESSION_SECRET}
    env_file: *common-env-file
    depends_on:
      - mongodb
    networks:
      - cobi-network

  qdrant:
    container_name: cobi-qdrant-${TAG}
    image: qdrant/qdrant:latest
    ports:
      - "${QDRANT_PORT:-6333}:6333"
      - "6334:6334"
    environment:
      QDRANT__SERVICE__GRPC_PORT: "6334"
    networks:
      - cobi-network
    volumes:
      - qdrant_data:/qdrant/storage

networks:
  cobi-network:
    driver: bridge

volumes:
  mongo_data:
  qdrant_data: